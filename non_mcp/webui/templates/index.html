<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>TriStage Search • Non‑MCP</title>
    <link rel="stylesheet" href="/static/style.css">
  </head>
  <body>
    <header>
      <div class="wrap row">
        <div class="nav">
          <div class="brand">TriStage RAG</div>
          <a href="/chat" class="pill">Chat</a>
          <a href="/search" class="pill">Search</a>
          <a href="/embed" class="pill">Embed</a>
        </div>
        {% if stats %}
        <div class="nav">
          <span class="pill">Device: {{ stats.config.device }}</span>
          <span class="pill">Docs: {{ stats.document_stats.total_documents }}</span>
          <span class="pill">Searches: {{ stats.search_count }}</span>
        </div>
        {% endif %}
      </div>
    </header>
    <main class="wrap grid">
      <section class="panel">
        <form action="/search" method="post" class="grid">
          <label for="q">Search</label>
          <input type="text" name="q" id="q" value="{{ query or '' }}" placeholder="Type a search query…" required>
          <div class="row">
            <div class="flex">
              <label class="muted">Top‑k</label>
              <select name="top_k">
                {% for k in [3,5,10,20] %}
                <option value="{{k}}" {% if (top_k or 10)==k %}selected{% endif %}>{{k}}</option>
                {% endfor %}
              </select>
            </div>
            <div class="right">
              <button class="btn" type="submit">Search</button>
            </div>
          </div>
        </form>
      </section>

      {% if result %}
      <section class="panel">
        <div class="row mb8">
          <div class="muted">Query: <strong>{{ result.query }}</strong></div>
          <div class="scores">
            <span class="chip">S1 {{ '%.3f'|format(result.stage1_time) }}s</span>
            <span class="chip">S2 {{ '%.3f'|format(result.stage2_time) }}s</span>
            <span class="chip">S3 {{ '%.3f'|format(result.stage3_time) }}s</span>
          </div>
        </div>
        <div class="list">
          {% for item in result.results %}
          <div class="item">
            <h4>#{{ item.rank }} • <span class="chip final">final {{ '%.4f'|format(item.final_score or 0) }}</span></h4>
            <div class="scores mb8">
              <span class="chip s1">s1 {{ '%.4f'|format(item.stage1_score or 0) }}</span>
              <span class="chip s2">s2 {{ '%.4f'|format(item.stage2_score or 0) }}</span>
              <span class="chip s3">s3 {{ '%.4f'|format(item.stage3_score or 0) }}</span>
            </div>
            <div>{{ (item.document or '')|hl(query or result.query)|safe }}</div>
          </div>
          {% endfor %}
        </div>
      </section>
      {% endif %}

      <div class="footer">Final ranking uses Stage‑3 (cross‑encoder). Query terms are highlighted.</div>
    </main>
  </body>
  </html>

